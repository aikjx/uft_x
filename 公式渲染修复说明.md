# 🔧 公式渲染修复说明

## 问题描述

公式显示"⚠️公式渲染失败 重试"，无法正确渲染数学符号。

### 错误示例
```
时空同一化方程
⚠️公式渲染失败 重试
描述时空的统一性，将时间与空间坐标统一表示
```

---

## 修复方案

### 1. 简化 MathFormula 组件

**问题原因**:
- 原组件逻辑过于复杂
- 公式格式处理有问题
- MathJax 调用方式不正确

**修复内容**:
- ✅ 简化组件逻辑
- ✅ 改进公式清理函数
- ✅ 优化 MathJax 调用
- ✅ 添加 MathJax 加载等待
- ✅ 改进错误处理

### 2. 核心改进

#### 公式清理
```typescript
const cleanFormula = (text: string): string => {
  if (!text) return ''
  
  // 移除首尾的 $ 符号
  let cleaned = text.trim()
    .replace(/^\$\$|\$\$$/g, '')
    .replace(/^\$|\$$/g, '')
    .replace(/^\\\[|\\\]$/g, '')
    .replace(/^\\\(|\\\)$/g, '')
  
  // 转换向量符号
  cleaned = cleaned.replace(/\\vec\{([^}]+)\}/g, '\\overrightarrow{$1}')
  
  return cleaned
}
```

#### MathJax 渲染
```typescript
// 等待 MathJax 加载
if (!window.MathJax) {
  let attempts = 0
  while (!window.MathJax && attempts < 10) {
    await new Promise(resolve => setTimeout(resolve, 500))
    attempts++
  }
}

// 设置公式内容
const delimiter = props.inline ? '\\(' : '\\['
const endDelimiter = props.inline ? '\\)' : '\\]'
formulaElement.value.textContent = `${delimiter}${cleaned}${endDelimiter}`

// 渲染
await window.MathJax.typesetPromise([formulaElement.value])
```

---

## 测试步骤

### 1. 重启开发服务器
```bash
# 停止当前服务器 (Ctrl+C)
pnpm dev
```

### 2. 清除浏览器缓存
- Windows: `Ctrl + Shift + R`
- Mac: `Cmd + Shift + R`

### 3. 访问公式页面
```
http://localhost:52025/formulas
```

### 4. 检查公式渲染

#### 预期效果
```
时空同一化方程
r⃗(t) = C⃗t = xı⃗ + yȷ⃗ + zk⃗
描述时空的统一性，将时间与空间坐标统一表示
```

#### 检查项
- [ ] 公式显示为数学符号（不是纯文本）
- [ ] 向量符号有箭头（r⃗ 而不是 vec{r}）
- [ ] 等号、加号等符号正确显示
- [ ] 没有"公式渲染失败"错误
- [ ] 公式格式美观

---

## 调试方法

### 1. 检查 MathJax 加载
打开浏览器控制台 (F12)：
```javascript
console.log('MathJax:', window.MathJax)
console.log('MathJax version:', window.MathJax?.version)
```

**预期输出**:
```
MathJax: {version: "3.2.2", ...}
MathJax version: 3.2.2
```

**如果是 undefined**:
- MathJax CDN 可能被屏蔽
- 检查网络连接
- 查看网络面板 (F12 -> Network)

### 2. 检查公式元素
```javascript
document.querySelectorAll('.math-formula').forEach(el => {
  console.log('Formula:', el.textContent)
  console.log('Has error:', el.querySelector('.formula-error'))
})
```

### 3. 手动触发渲染
```javascript
if (window.MathJax) {
  window.MathJax.typesetPromise().then(() => {
    console.log('渲染完成')
  }).catch(err => {
    console.error('渲染失败:', err)
  })
}
```

---

## 常见问题

### Q1: 公式仍然显示"渲染失败"
**原因**: MathJax 未加载或加载失败

**解决方案**:
1. 检查网络连接
2. 测试 CDN 是否可访问:
```bash
curl -I https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js
```
3. 如果无法访问，使用备用 CDN

### Q2: 公式显示为纯文本
**原因**: MathJax 渲染未执行

**解决方案**:
1. 清除浏览器缓存
2. 重启开发服务器
3. 检查控制台错误

### Q3: 向量符号没有箭头
**原因**: `\vec` 命令未转换

**解决方案**:
- 组件已自动转换 `\vec` 为 `\overrightarrow`
- 如果仍然有问题，检查公式源数据

### Q4: 公式格式错乱
**原因**: 公式语法错误

**解决方案**:
1. 检查公式语法是否正确
2. 确保括号匹配
3. 检查特殊字符是否转义

---

## 备用方案

### 方案A: 使用备用 CDN

如果 jsdelivr CDN 无法访问，在 `index.html` 中替换：

```html
<!-- 原 CDN -->
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<!-- 备用 CDN 1: cdnjs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-svg.js"></script>

<!-- 备用 CDN 2: unpkg -->
<script src="https://unpkg.com/mathjax@3/es5/tex-svg.js"></script>
```

### 方案B: 使用本地 MathJax

```bash
# 安装本地 MathJax
pnpm add mathjax@3
```

然后在 `src/main.ts` 中导入：
```typescript
import 'mathjax/es5/tex-svg.js'
```

### 方案C: 降级显示

如果 MathJax 完全无法使用，可以显示 LaTeX 源代码：

```vue
<template>
  <div class="formula-fallback">
    <code>{{ formula }}</code>
  </div>
</template>
```

---

## 验证清单

### ✅ 基本功能
- [ ] 公式可以正常渲染
- [ ] 没有"渲染失败"错误
- [ ] 数学符号显示正确

### ✅ 特殊符号
- [ ] 向量符号有箭头 (r⃗)
- [ ] 希腊字母正确显示 (α, β, γ)
- [ ] 分数正确显示
- [ ] 上下标正确显示

### ✅ 交互功能
- [ ] 点击公式可以查看详情
- [ ] 重试按钮可以工作
- [ ] 悬停有高亮效果

### ✅ 响应式
- [ ] 桌面端显示正常
- [ ] 移动端显示正常
- [ ] 不同尺寸下格式正确

---

## 性能优化

### 1. 延迟渲染
```typescript
// 延迟 100ms 渲染，确保 MathJax 已加载
setTimeout(() => {
  renderFormula()
}, 100)
```

### 2. 批量渲染
```typescript
// 一次渲染多个公式
await window.MathJax.typesetPromise(elements)
```

### 3. 缓存清理
```typescript
// 组件卸载时清理
onBeforeUnmount(() => {
  if (window.MathJax?.typesetClear) {
    window.MathJax.typesetClear([formulaElement.value])
  }
})
```

---

## 预期效果

### 修复前 ❌
```
时空同一化方程
⚠️公式渲染失败 重试
描述时空的统一性
```

### 修复后 ✅
```
时空同一化方程
r⃗(t) = C⃗t = xı⃗ + yȷ⃗ + zk⃗
描述时空的统一性，将时间与空间坐标统一表示
```

---

## 技术细节

### MathJax 配置
在 `index.html` 中的配置：
```javascript
window.MathJax = {
  tex: {
    inlineMath: [['\\(', '\\)']],
    displayMath: [['\\[', '\\]']],
    macros: {
      vec: ['\\overrightarrow{#1}', 1]
    }
  },
  svg: {
    scale: 1.2
  }
}
```

### 公式分隔符
- 内联公式: `\(...\)`
- 块级公式: `\[...\]`

### 向量符号
- 输入: `\vec{r}`
- 转换: `\overrightarrow{r}`
- 显示: r⃗

---

**修复完成！立即测试！** 🚀

**测试地址**: http://localhost:52025/formulas

**预期结果**: 所有公式正确渲染，显示为数学符号。

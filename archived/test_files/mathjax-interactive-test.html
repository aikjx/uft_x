<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathJax äº¤äº’å¼æµ‹è¯•å¹³å°</title>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                packages: {
                    '[+]': [
                        'base', 'ams', 'newcommand', 'configmacros', 'action',
                        'bbox', 'boldsymbol', 'braket', 'cancel', 'color',
                        'enclose', 'extpfeil', 'html', 'mathtools', 'mhchem',
                        'physics', 'textmacros', 'unicode', 'verb'
                    ]
                },
                macros: {
                    RR: "\\mathbb{R}",
                    CC: "\\mathbb{C}",
                    NN: "\\mathbb{N}",
                    ZZ: "\\mathbb{Z}",
                    QQ: "\\mathbb{Q}",
                    vec: ["\\mathbf{#1}", 1],
                    mat: ["\\mathbf{#1}", 1],
                    dd: "\\mathrm{d}",
                    pp: "\\partial",
                    grad: "\\nabla",
                    ket: ["|#1\\rangle", 1],
                    bra: ["\\langle#1|", 1],
                    braket: ["\\langle#1|#2\\rangle", 2]
                },
                tags: 'ams'
            },
            startup: {
                ready() {
                    console.log('MathJax äº¤äº’å¼æµ‹è¯•å¹³å°å‡†å¤‡å°±ç»ª');
                    MathJax.startup.defaultReady();
                    initializeInteractiveFeatures();
                }
            },
            options: {
                renderActions: {
                    addMenu: [0, '', '']
                }
            }
        };
    </script>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2.5em;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .panel h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .editor-panel {
            min-height: 500px;
        }
        
        .preview-panel {
            min-height: 500px;
            background: #f8f9fa;
        }
        
        .editor-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f1f3f4;
            border-radius: 10px;
        }
        
        .toolbar-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .toolbar-group label {
            font-size: 12px;
            color: #666;
            margin-right: 5px;
        }
        
        button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }
        
        button.active {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }
        
        .math-editor {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }
        
        .math-editor:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }
        
        .preview-area {
            background: white;
            padding: 20px;
            border-radius: 10px;
            min-height: 300px;
            border: 2px solid #e9ecef;
            overflow-y: auto;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .template-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .template-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .template-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .template-preview {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .features-panel {
            grid-column: 1 / -1;
        }
        
        .feature-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .tab-button {
            background: none;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: linear-gradient(45deg, transparent, rgba(52, 152, 219, 0.1));
        }
        
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .test-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .test-item h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .math-output {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #e9ecef;
            min-height: 50px;
        }
        
        .status-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 25px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .status-info {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #27ae60;
        }
        
        .error-display {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            color: #c53030;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ® MathJax äº¤äº’å¼æµ‹è¯•å¹³å°</h1>
            <p>å®æ—¶ç¼–è¾‘ã€é¢„è§ˆå’Œæµ‹è¯•æ•°å­¦å…¬å¼</p>
        </div>
        
        <div class="main-grid">
            <!-- ç¼–è¾‘å™¨é¢æ¿ -->
            <div class="panel editor-panel">
                <h2>âœï¸ æ•°å­¦å…¬å¼ç¼–è¾‘å™¨</h2>
                
                <div class="editor-toolbar">
                    <div class="toolbar-group">
                        <label>å¿«é€Ÿæ’å…¥:</label>
                        <button onclick="insertSymbol('\\\\frac{a}{b}')">åˆ†æ•°</button>
                        <button onclick="insertSymbol('\\\\sqrt{x}')">æ ¹å·</button>
                        <button onclick="insertSymbol('x^{2}')">ä¸Šæ ‡</button>
                        <button onclick="insertSymbol('x_{i}')">ä¸‹æ ‡</button>
                        <button onclick="insertSymbol('\\\\sum_{i=1}^{n}')">æ±‚å’Œ</button>
                        <button onclick="insertSymbol('\\\\int_{a}^{b}')">ç§¯åˆ†</button>
                    </div>
                    
                    <div class="toolbar-group">
                        <label>å¸Œè…Šå­—æ¯:</label>
                        <button onclick="insertSymbol('\\\\alpha')">Î±</button>
                        <button onclick="insertSymbol('\\\\beta')">Î²</button>
                        <button onclick="insertSymbol('\\\\gamma')">Î³</button>
                        <button onclick="insertSymbol('\\\\delta')">Î´</button>
                        <button onclick="insertSymbol('\\\\pi')">Ï€</button>
                        <button onclick="insertSymbol('\\\\theta')">Î¸</button>
                    </div>
                    
                    <div class="toolbar-group">
                        <label>æ“ä½œ:</label>
                        <button onclick="clearEditor()">æ¸…é™¤</button>
                        <button onclick="formatCode()">æ ¼å¼åŒ–</button>
                        <button onclick="validateSyntax()">éªŒè¯</button>
                    </div>
                </div>
                
                <textarea id="math-editor" class="math-editor" placeholder="åœ¨è¿™é‡Œè¾“å…¥æ•°å­¦å…¬å¼...
ä¾‹å¦‚:
$$E = mc^2$$
\\begin{align}
x &= a + b \\\\
y &= c + d
\\end{align}

æ”¯æŒå†…è”æ•°å­¦: $x^2 + y^2 = r^2$
æ”¯æŒæ˜¾ç¤ºæ•°å­¦: $$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$"></textarea>
                
                <div id="error-display" class="error-display" style="display: none;"></div>
            </div>
            
            <!-- é¢„è§ˆé¢æ¿ -->
            <div class="panel preview-panel">
                <h2>ğŸ‘ï¸ å®æ—¶é¢„è§ˆ</h2>
                <div id="preview-area" class="preview-area">
                    <p style="color: #666; text-align: center; margin-top: 100px;">
                        åœ¨å·¦ä¾§ç¼–è¾‘å™¨ä¸­è¾“å…¥å…¬å¼ï¼Œé¢„è§ˆå°†åœ¨è¿™é‡Œå®æ—¶æ˜¾ç¤º
                    </p>
                </div>
            </div>
        </div>
        
        <!-- æ¨¡æ¿åº“ -->
        <div class="panel">
            <h2>ğŸ“š å…¬å¼æ¨¡æ¿åº“</h2>
            <div class="template-grid">
                <div class="template-card" onclick="loadTemplate('quadratic')">
                    <h3>äºŒæ¬¡å…¬å¼</h3>
                    <div class="template-preview">x = (-b Â± âˆš(bÂ²-4ac)) / 2a</div>
                    <p>æ±‚è§£äºŒæ¬¡æ–¹ç¨‹çš„æ ‡å‡†å…¬å¼</p>
                </div>
                
                <div class="template-card" onclick="loadTemplate('matrix')">
                    <h3>çŸ©é˜µè¿ç®—</h3>
                    <div class="template-preview">Matrix multiplication</div>
                    <p>çŸ©é˜µä¹˜æ³•å’Œçº¿æ€§å˜æ¢</p>
                </div>
                
                <div class="template-card" onclick="loadTemplate('calculus')">
                    <h3>å¾®ç§¯åˆ†</h3>
                    <div class="template-preview">âˆ« f(x) dx</div>
                    <p>å¯¼æ•°å’Œç§¯åˆ†å…¬å¼</p>
                </div>
                
                <div class="template-card" onclick="loadTemplate('physics')">
                    <h3>ç‰©ç†å…¬å¼</h3>
                    <div class="template-preview">E = mcÂ²</div>
                    <p>ç»å…¸ç‰©ç†å’Œé‡å­åŠ›å­¦</p>
                </div>
                
                <div class="template-card" onclick="loadTemplate('statistics')">
                    <h3>ç»Ÿè®¡å­¦</h3>
                    <div class="template-preview">Normal Distribution</div>
                    <p>æ¦‚ç‡åˆ†å¸ƒå’Œç»Ÿè®¡å…¬å¼</p>
                </div>
                
                <div class="template-card" onclick="loadTemplate('geometry')">
                    <h3>å‡ ä½•å­¦</h3>
                    <div class="template-preview">Trigonometry</div>
                    <p>ä¸‰è§’å‡½æ•°å’Œå‡ ä½•å®šç†</p>
                </div>
            </div>
        </div>
        
        <!-- åŠŸèƒ½æµ‹è¯•é¢æ¿ -->
        <div class="panel features-panel">
            <h2>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h2>
            
            <div class="feature-tabs">
                <button class="tab-button active" onclick="switchTab('rendering')">æ¸²æŸ“æµ‹è¯•</button>
                <button class="tab-button" onclick="switchTab('extensions')">æ‰©å±•åŠŸèƒ½</button>
                <button class="tab-button" onclick="switchTab('performance')">æ€§èƒ½æµ‹è¯•</button>
                <button class="tab-button" onclick="switchTab('accessibility')">å¯è®¿é—®æ€§</button>
            </div>
            
            <div id="rendering-tab" class="tab-content active">
                <div class="test-grid">
                    <div class="test-item">
                        <h4>åŸºç¡€æ¸²æŸ“</h4>
                        <div class="math-output" id="basic-render">$$E = mc^2$$</div>
                        <button onclick="testBasicRendering()">æµ‹è¯•åŸºç¡€æ¸²æŸ“</button>
                    </div>
                    
                    <div class="test-item">
                        <h4>å¤æ‚å…¬å¼</h4>
                        <div class="math-output" id="complex-render"></div>
                        <button onclick="testComplexFormulas()">æµ‹è¯•å¤æ‚å…¬å¼</button>
                    </div>
                    
                    <div class="test-item">
                        <h4>åŠ¨æ€æ›´æ–°</h4>
                        <div class="math-output" id="dynamic-render">$$x = 1$$</div>
                        <button onclick="testDynamicUpdate()">æµ‹è¯•åŠ¨æ€æ›´æ–°</button>
                    </div>
                </div>
            </div>
            
            <div id="extensions-tab" class="tab-content">
                <div class="test-grid">
                    <div class="test-item">
                        <h4>åŒ–å­¦å…¬å¼ (mhchem)</h4>
                        <div class="math-output" id="chemistry-test">$$\\ce{H2O}$$</div>
                        <button onclick="testChemistry()">æµ‹è¯•åŒ–å­¦å…¬å¼</button>
                    </div>
                    
                    <div class="test-item">
                        <h4>ç‰©ç†ç¬¦å· (physics)</h4>
                        <div class="math-output" id="physics-test">$$\\ket{\\psi}$$</div>
                        <button onclick="testPhysics()">æµ‹è¯•ç‰©ç†ç¬¦å·</button>
                    </div>
                    
                    <div class="test-item">
                        <h4>é¢œè‰²å’Œæ ·å¼</h4>
                        <div class="math-output" id="color-test">$$\\color{red}{x} + \\color{blue}{y}$$</div>
                        <button onclick="testColors()">æµ‹è¯•é¢œè‰²</button>
                    </div>
                </div>
            </div>
            
            <div id="performance-tab" class="tab-content">
                <div class="test-grid">
                    <div class="test-item">
                        <h4>æ¸²æŸ“é€Ÿåº¦</h4>
                        <div id="speed-result">ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹</div>
                        <button onclick="testRenderingSpeed()">æµ‹è¯•æ¸²æŸ“é€Ÿåº¦</button>
                    </div>
                    
                    <div class="test-item">
                        <h4>å†…å­˜ä½¿ç”¨</h4>
                        <div id="memory-result">ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹</div>
                        <button onclick="testMemoryUsage()">æµ‹è¯•å†…å­˜ä½¿ç”¨</button>
                    </div>
                </div>
            </div>
            
            <div id="accessibility-tab" class="tab-content">
                <div class="test-grid">
                    <div class="test-item">
                        <h4>å±å¹•é˜…è¯»å™¨æ”¯æŒ</h4>
                        <div class="math-output" id="accessibility-test">$$\\frac{a}{b}$$</div>
                        <button onclick="testAccessibility()">æµ‹è¯•å¯è®¿é—®æ€§</button>
                    </div>
                    
                    <div class="test-item">
                        <h4>é”®ç›˜å¯¼èˆª</h4>
                        <div id="keyboard-result">ä½¿ç”¨Tabé”®å¯¼èˆªæ•°å­¦å…¬å¼</div>
                        <button onclick="testKeyboardNavigation()">æµ‹è¯•é”®ç›˜å¯¼èˆª</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div class="status-info">
                <div class="status-item">
                    <div class="status-indicator" id="mathjax-status"></div>
                    <span>MathJax çŠ¶æ€</span>
                </div>
                <div class="status-item">
                    <span id="render-count">æ¸²æŸ“æ¬¡æ•°: 0</span>
                </div>
                <div class="status-item">
                    <span id="last-render-time">ä¸Šæ¬¡æ¸²æŸ“: -</span>
                </div>
            </div>
            <div>
                <button onclick="exportCode()">ğŸ“¤ å¯¼å‡ºä»£ç </button>
                <button onclick="shareFormula()">ğŸ”— åˆ†äº«å…¬å¼</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let renderCount = 0;
        let lastRenderTime = 0;
        let currentTab = 'rendering';
        
        // å…¬å¼æ¨¡æ¿
        const templates = {
            quadratic: `$$x = \\frac{-b \\pm \\sqrt{b^2 - 4ac}}{2a}$$`,
            matrix: `$$\\begin{pmatrix}
a & b & c \\\\
d & e & f \\\\
g & h & i
\\end{pmatrix} \\begin{pmatrix}
x \\\\ y \\\\ z
\\end{pmatrix} = \\begin{pmatrix}
ax + by + cz \\\\
dx + ey + fz \\\\
gx + hy + iz
\\end{pmatrix}$$`,
            calculus: `$$\\begin{align}
\\frac{d}{dx}[f(x)g(x)] &= f'(x)g(x) + f(x)g'(x) \\\\
\\int_{a}^{b} f(x) dx &= F(b) - F(a) \\\\
\\lim_{x \\to 0} \\frac{\\sin x}{x} &= 1
\\end{align}$$`,
            physics: `$$\\begin{align}
E &= mc^2 \\\\
F &= ma \\\\
i\\hbar\\frac{\\partial}{\\partial t}|\\psi\\rangle &= \\hat{H}|\\psi\\rangle \\\\
\\nabla \\cdot \\vec{E} &= \\frac{\\rho}{\\epsilon_0}
\\end{align}$$`,
            statistics: `$$\\begin{align}
f(x) &= \\frac{1}{\\sqrt{2\\pi\\sigma^2}} e^{-\\frac{(x-\\mu)^2}{2\\sigma^2}} \\\\
P(A|B) &= \\frac{P(B|A)P(A)}{P(B)} \\\\
\\bar{x} &= \\frac{1}{n}\\sum_{i=1}^{n} x_i
\\end{align}$$`,
            geometry: `$$\\begin{align}
\\sin^2\\theta + \\cos^2\\theta &= 1 \\\\
e^{i\\theta} &= \\cos\\theta + i\\sin\\theta \\\\
c^2 &= a^2 + b^2 - 2ab\\cos C \\\\
A &= \\pi r^2
\\end{align}$$`
        };
        
        // åˆå§‹åŒ–äº¤äº’åŠŸèƒ½
        function initializeInteractiveFeatures() {
            const editor = document.getElementById('math-editor');
            const previewArea = document.getElementById('preview-area');
            
            // å®æ—¶é¢„è§ˆ
            editor.addEventListener('input', debounce(function() {
                updatePreview();
            }, 300));
            
            // åˆå§‹æ¸²æŸ“
            setTimeout(() => {
                renderAllMath();
            }, 500);
        }
        
        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const editor = document.getElementById('math-editor');
            const previewArea = document.getElementById('preview-area');
            const errorDisplay = document.getElementById('error-display');
            
            const content = editor.value.trim();
            
            if (!content) {
                previewArea.innerHTML = '<p style="color: #666; text-align: center; margin-top: 100px;">åœ¨å·¦ä¾§ç¼–è¾‘å™¨ä¸­è¾“å…¥å…¬å¼ï¼Œé¢„è§ˆå°†åœ¨è¿™é‡Œå®æ—¶æ˜¾ç¤º</p>';
                errorDisplay.style.display = 'none';
                return;
            }
            
            // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
            previewArea.innerHTML = content;
            errorDisplay.style.display = 'none';
            
            const startTime = performance.now();
            
            // æ¸²æŸ“æ•°å­¦å…¬å¼
            MathJax.typesetPromise([previewArea]).then(() => {
                const endTime = performance.now();
                lastRenderTime = endTime - startTime;
                renderCount++;
                
                updateStatusBar();
                
            }).catch(error => {
                console.error('MathJax æ¸²æŸ“é”™è¯¯:', error);
                errorDisplay.textContent = `æ¸²æŸ“é”™è¯¯: ${error.message}`;
                errorDisplay.style.display = 'block';
            });
        }
        
        // æ›´æ–°çŠ¶æ€æ 
        function updateStatusBar() {
            document.getElementById('render-count').textContent = `æ¸²æŸ“æ¬¡æ•°: ${renderCount}`;
            document.getElementById('last-render-time').textContent = `ä¸Šæ¬¡æ¸²æŸ“: ${lastRenderTime.toFixed(2)}ms`;
        }
        
        // æ’å…¥ç¬¦å·
        function insertSymbol(symbol) {
            const editor = document.getElementById('math-editor');
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            
            editor.value = text.substring(0, start) + symbol + text.substring(end);
            editor.focus();
            editor.setSelectionRange(start + symbol.length, start + symbol.length);
            
            updatePreview();
        }
        
        // æ¸…é™¤ç¼–è¾‘å™¨
        function clearEditor() {
            document.getElementById('math-editor').value = '';
            updatePreview();
        }
        
        // æ ¼å¼åŒ–ä»£ç 
        function formatCode() {
            const editor = document.getElementById('math-editor');
            let content = editor.value;
            
            // ç®€å•çš„æ ¼å¼åŒ–è§„åˆ™
            content = content.replace(/\\\\\\\\/g, '\\\\\\n');
            content = content.replace(/\\begin\{align\}/g, '\\n\\\\begin{align}\\n');
            content = content.replace(/\\end\{align\}/g, '\\n\\\\end{align}\\n');
            content = content.replace(/&=/g, ' &= ');
            
            editor.value = content;
            updatePreview();
        }
        
        // éªŒè¯è¯­æ³•
        function validateSyntax() {
            const editor = document.getElementById('math-editor');
            const content = editor.value;
            
            // ç®€å•çš„è¯­æ³•æ£€æŸ¥
            const errors = [];
            
            // æ£€æŸ¥æ‹¬å·åŒ¹é…
            const brackets = { '{': '}', '[': ']', '(': ')' };
            const stack = [];
            
            for (let i = 0; i < content.length; i++) {
                const char = content[i];
                if (brackets[char]) {
                    stack.push(char);
                } else if (Object.values(brackets).includes(char)) {
                    const last = stack.pop();
                    if (!last || brackets[last] !== char) {
                        errors.push(`ç¬¬ ${i + 1} ä½: æ‹¬å·ä¸åŒ¹é…`);
                    }
                }
            }
            
            if (stack.length > 0) {
                errors.push('å­˜åœ¨æœªé—­åˆçš„æ‹¬å·');
            }
            
            // æ˜¾ç¤ºç»“æœ
            const errorDisplay = document.getElementById('error-display');
            if (errors.length > 0) {
                errorDisplay.textContent = 'è¯­æ³•é”™è¯¯: ' + errors.join(', ');
                errorDisplay.style.display = 'block';
            } else {
                errorDisplay.textContent = 'âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡';
                errorDisplay.style.display = 'block';
                errorDisplay.style.background = '#f0fff4';
                errorDisplay.style.color = '#22543d';
                errorDisplay.style.borderColor = '#9ae6b4';
                
                setTimeout(() => {
                    errorDisplay.style.display = 'none';
                    errorDisplay.style.background = '#fff5f5';
                    errorDisplay.style.color = '#c53030';
                    errorDisplay.style.borderColor = '#fed7d7';
                }, 3000);
            }
        }
        
        // åŠ è½½æ¨¡æ¿
        function loadTemplate(templateName) {
            const editor = document.getElementById('math-editor');
            editor.value = templates[templateName] || '';
            updatePreview();
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            currentTab = tabName;
        }
        
        // æµ‹è¯•å‡½æ•°
        function testBasicRendering() {
            const output = document.getElementById('basic-render');
            output.innerHTML = '$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$';
            MathJax.typesetPromise([output]);
        }
        
        function testComplexFormulas() {
            const output = document.getElementById('complex-render');
            output.innerHTML = `$$\\begin{pmatrix}
\\cos\\theta & -\\sin\\theta \\\\
\\sin\\theta & \\cos\\theta
\\end{pmatrix} \\begin{pmatrix}
x \\\\ y
\\end{pmatrix} = \\begin{pmatrix}
x\\cos\\theta - y\\sin\\theta \\\\
x\\sin\\theta + y\\cos\\theta
\\end{pmatrix}$$`;
            MathJax.typesetPromise([output]);
        }
        
        function testDynamicUpdate() {
            const output = document.getElementById('dynamic-render');
            let counter = 1;
            
            const interval = setInterval(() => {
                counter++;
                output.innerHTML = `$$x = ${counter}$$`;
                MathJax.typesetPromise([output]);
                
                if (counter >= 10) {
                    clearInterval(interval);
                }
            }, 500);
        }
        
        function testChemistry() {
            const output = document.getElementById('chemistry-test');
            output.innerHTML = '$$\\ce{2H2 + O2 -> 2H2O}$$';
            MathJax.typesetPromise([output]);
        }
        
        function testPhysics() {
            const output = document.getElementById('physics-test');
            output.innerHTML = '$$\\braket{\\psi}{\\phi} = \\int_{-\\infty}^{\\infty} \\psi^*(x) \\phi(x) dx$$';
            MathJax.typesetPromise([output]);
        }
        
        function testColors() {
            const output = document.getElementById('color-test');
            output.innerHTML = '$$\\color{red}{a}x^2 + \\color{blue}{b}x + \\color{green}{c} = 0$$';
            MathJax.typesetPromise([output]);
        }
        
        function testRenderingSpeed() {
            const result = document.getElementById('speed-result');
            const formulas = [];
            
            // ç”Ÿæˆ100ä¸ªå…¬å¼
            for (let i = 0; i < 100; i++) {
                formulas.push(`$$x_{${i}} = \\frac{${i}}{${i + 1}}$$`);
            }
            
            const testDiv = document.createElement('div');
            testDiv.innerHTML = formulas.join('');
            document.body.appendChild(testDiv);
            
            const startTime = performance.now();
            
            MathJax.typesetPromise([testDiv]).then(() => {
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                result.innerHTML = `æ¸²æŸ“100ä¸ªå…¬å¼ç”¨æ—¶: ${duration.toFixed(2)}ms<br>å¹³å‡: ${(duration / 100).toFixed(2)}ms/å…¬å¼`;
                
                document.body.removeChild(testDiv);
            });
        }
        
        function testMemoryUsage() {
            const result = document.getElementById('memory-result');
            
            if (performance.memory) {
                const before = performance.memory.usedJSHeapSize;
                
                // åˆ›å»ºå¤§é‡æ•°å­¦å…¬å¼
                const testDiv = document.createElement('div');
                const formulas = [];
                
                for (let i = 0; i < 500; i++) {
                    formulas.push(`$$\\sum_{n=1}^{${i + 1}} \\frac{1}{n^2} = \\frac{\\pi^2}{6}$$`);
                }
                
                testDiv.innerHTML = formulas.join('');
                document.body.appendChild(testDiv);
                
                MathJax.typesetPromise([testDiv]).then(() => {
                    const after = performance.memory.usedJSHeapSize;
                    const increase = (after - before) / 1024 / 1024;
                    
                    result.innerHTML = `æ¸²æŸ“500ä¸ªå…¬å¼å†…å­˜å¢åŠ : ${increase.toFixed(2)}MB<br>å¹³å‡: ${(increase / 500 * 1024).toFixed(2)}KB/å…¬å¼`;
                    
                    document.body.removeChild(testDiv);
                });
            } else {
                result.innerHTML = 'æµè§ˆå™¨ä¸æ”¯æŒå†…å­˜ç›‘æ§';
            }
        }
        
        function testAccessibility() {
            const output = document.getElementById('accessibility-test');
            output.innerHTML = '$$\\frac{\\sqrt{a^2 + b^2}}{c + d}$$';
            
            MathJax.typesetPromise([output]).then(() => {
                // æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†å¯è®¿é—®æ€§å±æ€§
                const mathElements = output.querySelectorAll('[role="math"]');
                if (mathElements.length > 0) {
                    console.log('âœ… å¯è®¿é—®æ€§æ”¯æŒæ­£å¸¸');
                } else {
                    console.log('âŒ å¯è®¿é—®æ€§æ”¯æŒå¼‚å¸¸');
                }
            });
        }
        
        function testKeyboardNavigation() {
            const result = document.getElementById('keyboard-result');
            result.innerHTML = 'è¯·ä½¿ç”¨Tabé”®å¯¼èˆªä¸‹é¢çš„å…¬å¼: $$\\int_0^1 x^2 dx = \\frac{1}{3}$$';
            
            MathJax.typesetPromise([result]);
        }
        
        // å¯¼å‡ºä»£ç 
        function exportCode() {
            const editor = document.getElementById('math-editor');
            const content = editor.value;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `math-formula-${Date.now()}.tex`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
        }
        
        // åˆ†äº«å…¬å¼
        function shareFormula() {
            const editor = document.getElementById('math-editor');
            const content = editor.value;
            
            if (navigator.share) {
                navigator.share({
                    title: 'MathJax å…¬å¼',
                    text: content
                });
            } else {
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(content).then(() => {
                    alert('å…¬å¼å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                });
            }
        }
        
        // æ¸²æŸ“æ‰€æœ‰æ•°å­¦å…¬å¼
        function renderAllMath() {
            MathJax.typesetPromise().then(() => {
                console.log('æ‰€æœ‰æ•°å­¦å…¬å¼æ¸²æŸ“å®Œæˆ');
                document.getElementById('mathjax-status').style.background = '#27ae60';
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('MathJax äº¤äº’å¼æµ‹è¯•å¹³å°åŠ è½½å®Œæˆ');
        });
    </script>
</body>
</html>
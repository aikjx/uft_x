<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathJax æ€§èƒ½å‹åŠ›æµ‹è¯•</title>
    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                packages: {'[+]': ['base', 'ams', 'newcommand', 'mathtools', 'physics']}
            },
            startup: {
                ready() {
                    console.log('MathJax æ€§èƒ½æµ‹è¯•å‡†å¤‡å°±ç»ª');
                    MathJax.startup.defaultReady();
                }
            }
        };
    </script>
    
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .controls {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 10px;
        }
        
        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .test-area {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .log {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        input[type="range"] {
            width: 200px;
            margin: 0 10px;
        }
        
        label {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>âš¡ MathJax æ€§èƒ½å‹åŠ›æµ‹è¯•</h1>
            <p>æµ‹è¯•å¤§é‡æ•°å­¦å…¬å¼çš„æ¸²æŸ“æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <button onclick="runBasicPerformanceTest()">ğŸš€ åŸºç¡€æ€§èƒ½æµ‹è¯•</button>
                <button onclick="runStressTest()">ğŸ’ª å‹åŠ›æµ‹è¯•</button>
                <button onclick="runMemoryTest()">ğŸ§  å†…å­˜æµ‹è¯•</button>
                <button onclick="runRealTimeTest()">â±ï¸ å®æ—¶æ¸²æŸ“æµ‹è¯•</button>
                <button onclick="clearTests()">ğŸ§¹ æ¸…é™¤æµ‹è¯•</button>
            </div>
            
            <div class="control-group">
                <label>
                    å…¬å¼æ•°é‡:
                    <input type="range" id="formula-count" min="10" max="1000" value="100" step="10">
                    <span id="count-display">100</span>
                </label>
                
                <label>
                    å¤æ‚åº¦:
                    <select id="complexity-level">
                        <option value="simple">ç®€å•</option>
                        <option value="medium" selected>ä¸­ç­‰</option>
                        <option value="complex">å¤æ‚</option>
                        <option value="extreme">æé™</option>
                    </select>
                </label>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-bar" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-value" id="render-time">0</div>
                <div class="metric-label">æ¸²æŸ“æ—¶é—´ (ms)</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-value" id="formulas-per-second">0</div>
                <div class="metric-label">å…¬å¼/ç§’</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-value" id="memory-usage">0</div>
                <div class="metric-label">å†…å­˜ä½¿ç”¨ (MB)</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-value" id="dom-nodes">0</div>
                <div class="metric-label">DOM èŠ‚ç‚¹æ•°</div>
            </div>
        </div>
        
        <div class="test-area" id="test-area">
            <p>æµ‹è¯•ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>
        </div>
        
        <div class="log" id="performance-log">
            æ€§èƒ½æµ‹è¯•æ—¥å¿—...
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let testRunning = false;
        let testResults = [];
        let memoryBaseline = 0;
        
        // å…¬å¼æ¨¡æ¿
        const formulaTemplates = {
            simple: [
                'x^2 + y^2 = r^2',
                'E = mc^2',
                'a^2 + b^2 = c^2',
                'f(x) = ax + b',
                '\\sin^2\\theta + \\cos^2\\theta = 1'
            ],
            medium: [
                '\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}',
                '\\sum_{n=1}^{\\infty} \\frac{1}{n^2} = \\frac{\\pi^2}{6}',
                '\\frac{d}{dx}[f(x)g(x)] = f\'(x)g(x) + f(x)g\'(x)',
                '\\lim_{x \\to 0} \\frac{\\sin x}{x} = 1',
                '\\nabla \\times \\vec{F} = \\left(\\frac{\\partial F_z}{\\partial y} - \\frac{\\partial F_y}{\\partial z}\\right)\\hat{i}'
            ],
            complex: [
                '\\begin{pmatrix} a & b & c \\\\ d & e & f \\\\ g & h & i \\end{pmatrix} \\begin{pmatrix} x \\\\ y \\\\ z \\end{pmatrix} = \\begin{pmatrix} ax+by+cz \\\\ dx+ey+fz \\\\ gx+hy+iz \\end{pmatrix}',
                '\\oint_C \\vec{F} \\cdot d\\vec{r} = \\iint_S (\\nabla \\times \\vec{F}) \\cdot d\\vec{S}',
                '\\begin{align} \\nabla \\cdot \\vec{E} &= \\frac{\\rho}{\\epsilon_0} \\\\ \\nabla \\times \\vec{E} &= -\\frac{\\partial \\vec{B}}{\\partial t} \\\\ \\nabla \\cdot \\vec{B} &= 0 \\\\ \\nabla \\times \\vec{B} &= \\mu_0\\vec{J} + \\mu_0\\epsilon_0\\frac{\\partial \\vec{E}}{\\partial t} \\end{align}',
                '\\sum_{n=0}^{\\infty} \\frac{f^{(n)}(a)}{n!}(x-a)^n = f(a) + f\'(a)(x-a) + \\frac{f\'\'(a)}{2!}(x-a)^2 + \\cdots',
                '\\int_0^{2\\pi} \\int_0^{\\pi} \\int_0^R r^2 \\sin\\theta \\, dr \\, d\\theta \\, d\\phi = \\frac{4\\pi R^3}{3}'
            ],
            extreme: [
                '\\begin{pmatrix} \\sum_{i=1}^n a_{1i}x_i \\\\ \\sum_{i=1}^n a_{2i}x_i \\\\ \\vdots \\\\ \\sum_{i=1}^n a_{mi}x_i \\end{pmatrix} = \\begin{pmatrix} b_1 \\\\ b_2 \\\\ \\vdots \\\\ b_m \\end{pmatrix}',
                '\\prod_{p \\text{ prime}} \\left(1 - p^{-s}\\right)^{-1} = \\sum_{n=1}^{\\infty} n^{-s} = \\zeta(s)',
                '\\int_{-\\infty}^{\\infty} \\int_{-\\infty}^{\\infty} e^{-\\frac{1}{2}(x^2 + y^2)} \\frac{1}{\\sqrt{2\\pi}} \\frac{1}{\\sqrt{2\\pi}} dx dy = 1',
                '\\begin{cases} \\frac{\\partial u}{\\partial t} = \\alpha \\nabla^2 u + f(x,y,z,t) \\\\ u(x,y,z,0) = u_0(x,y,z) \\\\ \\frac{\\partial u}{\\partial n}\\bigg|_{\\partial \\Omega} = g(x,y,z,t) \\end{cases}',
                '\\mathcal{L}\\{f(t)\\} = F(s) = \\int_0^{\\infty} e^{-st} f(t) dt \\quad \\text{where} \\quad \\mathcal{L}^{-1}\\{F(s)\\} = f(t)'
            ]
        };
        
        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('performance-log');
            logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[Performance Test] ${message}`);
        }
        
        // æ›´æ–°æŒ‡æ ‡
        function updateMetrics(renderTime, formulaCount, memoryUsage, domNodes) {
            document.getElementById('render-time').textContent = renderTime.toFixed(2);
            document.getElementById('formulas-per-second').textContent = (formulaCount / (renderTime / 1000)).toFixed(1);
            document.getElementById('memory-usage').textContent = memoryUsage.toFixed(2);
            document.getElementById('dom-nodes').textContent = domNodes;
        }
        
        // è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
        function getMemoryUsage() {
            if (performance.memory) {
                return performance.memory.usedJSHeapSize / 1024 / 1024; // MB
            }
            return 0;
        }
        
        // è·å–DOMèŠ‚ç‚¹æ•°
        function getDOMNodeCount() {
            return document.querySelectorAll('*').length;
        }
        
        // ç”Ÿæˆæµ‹è¯•å…¬å¼
        function generateFormulas(count, complexity) {
            const templates = formulaTemplates[complexity];
            const formulas = [];
            
            for (let i = 0; i < count; i++) {
                const template = templates[i % templates.length];
                // æ·»åŠ ä¸€äº›å˜åŒ–
                let formula = template.replace(/x/g, `x_{${i}}`);
                formula = formula.replace(/n/g, `n_{${i % 10}}`);
                formulas.push(`$$${formula}$$`);
            }
            
            return formulas;
        }
        
        // åŸºç¡€æ€§èƒ½æµ‹è¯•
        async function runBasicPerformanceTest() {
            if (testRunning) return;
            testRunning = true;
            
            const count = parseInt(document.getElementById('formula-count').value);
            const complexity = document.getElementById('complexity-level').value;
            
            log(`å¼€å§‹åŸºç¡€æ€§èƒ½æµ‹è¯•: ${count} ä¸ª ${complexity} å…¬å¼`);
            
            const testArea = document.getElementById('test-area');
            const progressBar = document.getElementById('progress-bar');
            
            // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
            testArea.innerHTML = '';
            
            // è®°å½•åŸºçº¿å†…å­˜
            memoryBaseline = getMemoryUsage();
            const startDOMNodes = getDOMNodeCount();
            
            // ç”Ÿæˆå…¬å¼
            const formulas = generateFormulas(count, complexity);
            
            // åˆ›å»ºæµ‹è¯•å…ƒç´ 
            const testElement = document.createElement('div');
            testElement.innerHTML = formulas.join('\\n');
            testArea.appendChild(testElement);
            
            // å¼€å§‹è®¡æ—¶
            const startTime = performance.now();
            
            try {
                // æ¸²æŸ“æ•°å­¦å…¬å¼
                await MathJax.typesetPromise([testElement]);
                
                const endTime = performance.now();
                const renderTime = endTime - startTime;
                const memoryUsage = getMemoryUsage() - memoryBaseline;
                const endDOMNodes = getDOMNodeCount() - startDOMNodes;
                
                // æ›´æ–°æŒ‡æ ‡
                updateMetrics(renderTime, count, memoryUsage, endDOMNodes);
                
                // æ›´æ–°è¿›åº¦æ¡
                progressBar.style.width = '100%';
                
                log(`âœ… åŸºç¡€æ€§èƒ½æµ‹è¯•å®Œæˆ: ${renderTime.toFixed(2)}ms, ${(count / (renderTime / 1000)).toFixed(1)} å…¬å¼/ç§’`);
                
                // ä¿å­˜ç»“æœ
                testResults.push({
                    type: 'basic',
                    count: count,
                    complexity: complexity,
                    renderTime: renderTime,
                    memoryUsage: memoryUsage,
                    domNodes: endDOMNodes,
                    formulasPerSecond: count / (renderTime / 1000)
                });
                
            } catch (error) {
                log(`âŒ åŸºç¡€æ€§èƒ½æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
            
            testRunning = false;
        }
        
        // å‹åŠ›æµ‹è¯•
        async function runStressTest() {
            if (testRunning) return;
            testRunning = true;
            
            log('å¼€å§‹å‹åŠ›æµ‹è¯•...');
            
            const testCases = [
                { count: 50, complexity: 'simple' },
                { count: 100, complexity: 'medium' },
                { count: 200, complexity: 'medium' },
                { count: 50, complexity: 'complex' },
                { count: 20, complexity: 'extreme' }
            ];
            
            const progressBar = document.getElementById('progress-bar');
            const testArea = document.getElementById('test-area');
            
            for (let i = 0; i < testCases.length; i++) {
                const testCase = testCases[i];
                const progress = ((i + 1) / testCases.length) * 100;
                
                log(`å‹åŠ›æµ‹è¯• ${i + 1}/${testCases.length}: ${testCase.count} ä¸ª ${testCase.complexity} å…¬å¼`);
                
                // æ¸…é™¤ä¹‹å‰çš„å†…å®¹
                testArea.innerHTML = '';
                
                // ç”Ÿæˆå…¬å¼
                const formulas = generateFormulas(testCase.count, testCase.complexity);
                const testElement = document.createElement('div');
                testElement.innerHTML = formulas.join('\\n');
                testArea.appendChild(testElement);
                
                const startTime = performance.now();
                const startMemory = getMemoryUsage();
                
                try {
                    await MathJax.typesetPromise([testElement]);
                    
                    const endTime = performance.now();
                    const renderTime = endTime - startTime;
                    const memoryUsage = getMemoryUsage() - startMemory;
                    
                    log(`  âœ… å®Œæˆ: ${renderTime.toFixed(2)}ms, å†…å­˜: ${memoryUsage.toFixed(2)}MB`);
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    progressBar.style.width = progress + '%';
                    
                    // çŸ­æš‚å»¶è¿Ÿä»¥é¿å…æµè§ˆå™¨å†»ç»“
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    log(`  âŒ å¤±è´¥: ${error.message}`);
                }
            }
            
            log('ğŸ‰ å‹åŠ›æµ‹è¯•å®Œæˆ');
            testRunning = false;
        }
        
        // å†…å­˜æµ‹è¯•
        async function runMemoryTest() {
            if (testRunning) return;
            testRunning = true;
            
            log('å¼€å§‹å†…å­˜æµ‹è¯•...');
            
            const testArea = document.getElementById('test-area');
            const progressBar = document.getElementById('progress-bar');
            
            // è®°å½•åˆå§‹å†…å­˜
            const initialMemory = getMemoryUsage();
            log(`åˆå§‹å†…å­˜ä½¿ç”¨: ${initialMemory.toFixed(2)}MB`);
            
            // é€æ­¥å¢åŠ å…¬å¼æ•°é‡
            const steps = [10, 50, 100, 200, 500];
            
            for (let i = 0; i < steps.length; i++) {
                const count = steps[i];
                const progress = ((i + 1) / steps.length) * 100;
                
                log(`å†…å­˜æµ‹è¯•æ­¥éª¤ ${i + 1}: ${count} ä¸ªå…¬å¼`);
                
                // ç”Ÿæˆå…¬å¼
                const formulas = generateFormulas(count, 'medium');
                const testElement = document.createElement('div');
                testElement.innerHTML = formulas.join('\\n');
                testArea.appendChild(testElement); // ç´¯ç§¯æ·»åŠ 
                
                const beforeRender = getMemoryUsage();
                
                try {
                    await MathJax.typesetPromise([testElement]);
                    
                    const afterRender = getMemoryUsage();
                    const memoryIncrease = afterRender - beforeRender;
                    const totalMemory = afterRender - initialMemory;
                    
                    log(`  å†…å­˜å¢åŠ : ${memoryIncrease.toFixed(2)}MB, æ€»è®¡: ${totalMemory.toFixed(2)}MB`);
                    
                    // æ›´æ–°æŒ‡æ ‡
                    updateMetrics(0, count, totalMemory, getDOMNodeCount());
                    progressBar.style.width = progress + '%';
                    
                    // å»¶è¿Ÿä»¥è§‚å¯Ÿå†…å­˜å˜åŒ–
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    log(`  âŒ å†…å­˜æµ‹è¯•å¤±è´¥: ${error.message}`);
                }
            }
            
            log('ğŸ§  å†…å­˜æµ‹è¯•å®Œæˆ');
            testRunning = false;
        }
        
        // å®æ—¶æ¸²æŸ“æµ‹è¯•
        async function runRealTimeTest() {
            if (testRunning) return;
            testRunning = true;
            
            log('å¼€å§‹å®æ—¶æ¸²æŸ“æµ‹è¯•...');
            
            const testArea = document.getElementById('test-area');
            const progressBar = document.getElementById('progress-bar');
            
            testArea.innerHTML = '<div id="realtime-container"></div>';
            const container = document.getElementById('realtime-container');
            
            const formulas = generateFormulas(50, 'medium');
            let totalTime = 0;
            
            for (let i = 0; i < formulas.length; i++) {
                const progress = ((i + 1) / formulas.length) * 100;
                
                // åˆ›å»ºæ–°çš„å…¬å¼å…ƒç´ 
                const formulaDiv = document.createElement('div');
                formulaDiv.innerHTML = formulas[i];
                container.appendChild(formulaDiv);
                
                const startTime = performance.now();
                
                try {
                    await MathJax.typesetPromise([formulaDiv]);
                    
                    const endTime = performance.now();
                    const renderTime = endTime - startTime;
                    totalTime += renderTime;
                    
                    // æ›´æ–°è¿›åº¦
                    progressBar.style.width = progress + '%';
                    
                    // å®æ—¶æ›´æ–°æŒ‡æ ‡
                    const avgTime = totalTime / (i + 1);
                    updateMetrics(avgTime, i + 1, getMemoryUsage() - memoryBaseline, getDOMNodeCount());
                    
                    // çŸ­æš‚å»¶è¿Ÿæ¨¡æ‹Ÿå®æ—¶è¾“å…¥
                    await new Promise(resolve => setTimeout(resolve, 50));
                    
                } catch (error) {
                    log(`å®æ—¶æ¸²æŸ“ç¬¬ ${i + 1} ä¸ªå…¬å¼å¤±è´¥: ${error.message}`);
                }
            }
            
            log(`â±ï¸ å®æ—¶æ¸²æŸ“æµ‹è¯•å®Œæˆ: å¹³å‡ ${(totalTime / formulas.length).toFixed(2)}ms/å…¬å¼`);
            testRunning = false;
        }
        
        // æ¸…é™¤æµ‹è¯•
        function clearTests() {
            document.getElementById('test-area').innerHTML = '<p>æµ‹è¯•ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º...</p>';
            document.getElementById('performance-log').innerHTML = 'æ€§èƒ½æµ‹è¯•æ—¥å¿—...';
            document.getElementById('progress-bar').style.width = '0%';
            
            // é‡ç½®æŒ‡æ ‡
            updateMetrics(0, 0, 0, 0);
            
            // æ¸…é™¤ç»“æœ
            testResults = [];
            
            log('ğŸ§¹ æµ‹è¯•å·²æ¸…é™¤');
        }
        
        // æ»‘å—äº‹ä»¶ç›‘å¬
        document.getElementById('formula-count').addEventListener('input', function(e) {
            document.getElementById('count-display').textContent = e.target.value;
        });
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            memoryBaseline = getMemoryUsage();
            log('ğŸ“„ MathJax æ€§èƒ½æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            log(`åŸºçº¿å†…å­˜ä½¿ç”¨: ${memoryBaseline.toFixed(2)}MB`);
        });
    </script>
</body>
</html>